<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>文法記述テスト</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Hiragino Sans',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;overflow-x:hidden}
    .container{background:#fff;border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.1);max-width:700px;width:100%}
    h1,h2{text-align:center;color:#333;margin-bottom:24px}
    h1{font-size:28px}
    h2{font-size:22px}
    .button{display:block;width:100%;padding:14px;margin-bottom:12px;border:none;border-radius:10px;font-size:18px;font-weight:700;cursor:pointer;transition:.2s;color:#fff;text-align:center;-webkit-appearance:none}
    .button:hover{transform:translateY(-1px);box-shadow:0 5px 12px rgba(0,0,0,.2)}
    .button:active{transform:translateY(0)}
    .button-purple{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
    .button-green{background:linear-gradient(135deg,#48bb78 0%,#2f855a 100%)}
    .button-blue{background:linear-gradient(135deg,#3182ce 0%,#2c5282 100%)}
    .button-gray{background:linear-gradient(135deg,#718096 0%,#4a5568 100%)}
    .button-red{background:linear-gradient(135deg,#f56565 0%,#c53030 100%)}
    .button-orange{background:linear-gradient(135deg,#ed8936 0%,#c05621 100%)}
    .form-group{margin-bottom:16px}
    label{display:block;margin-bottom:6px;font-weight:700;color:#4a5568;font-size:14px}
    input[type=text],input[type=password],select,textarea{width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:16px;transition:border-color .2s;-webkit-appearance:none;font-family:inherit}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#667eea}
    textarea{resize:vertical;min-height:80px}
    .quiz-container{text-align:left}
    .question-box{background:#f8f9fa;border-radius:12px;padding:20px;margin-bottom:20px}
    .question-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .question-number{font-size:14px;color:#718096;font-weight:600}
    .point-badge{background:#667eea;color:#fff;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}
    .question-title{font-size:13px;color:#4a5568;margin-bottom:8px;font-weight:600}
    .question-text{font-size:20px;font-weight:700;color:#2d3748;line-height:1.5}
    .answer-section{margin-top:20px}
    .answer-input{width:100%;padding:12px;border:2px solid #cbd5e0;border-radius:8px;font-size:16px;background:#fff;transition:.2s}
    .answer-input:focus{border-color:#667eea;background:#f7fafc}
    .answer-input.correct{border-color:#48bb78;background:#f0fff4}
    .answer-input.incorrect{border-color:#f56565;background:#fff5f5}
    .model-answer{margin-top:12px;padding:12px;background:#e6fffa;border:2px solid #38b2ac;border-radius:8px;display:none}
    .model-answer-label{font-size:12px;color:#2c7a7b;font-weight:700;margin-bottom:4px}
    .model-answer-text{color:#234e52;font-size:15px;line-height:1.5}
    .progress-bar{height:8px;background:#e2e8f0;border-radius:4px;margin-bottom:20px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg,#667eea 0%,#48bb78 100%);transition:width .3s;border-radius:4px}
    .score-display{font-size:64px;font-weight:800;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:18px 0;text-align:center}
    .hidden{display:none}
    .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .success-box{background:#f0fff4;border:2px solid #9ae6b4;border-radius:8px;padding:12px;margin-bottom:12px;color:#276749;font-size:14px}
    .result-details{background:#f7fafc;border-radius:12px;padding:20px;margin:20px 0}
    .result-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e2e8f0}
    .result-item:last-child{border-bottom:none}
    .result-label{color:#4a5568;font-weight:600}
    .result-value{color:#2d3748}
    .select-controls{display:flex;gap:10px;margin-bottom:10px}
    .select-button{padding:8px 16px;border:2px solid #667eea;border-radius:8px;background:#fff;color:#667eea;cursor:pointer;font-size:14px;font-weight:600;transition:.2s}
    .select-button:hover{background:#667eea;color:#fff}
    .timer{font-size:18px;color:#667eea;font-weight:700;text-align:center;margin-bottom:10px}
    .answer-status{margin-top:8px;font-size:14px;font-weight:600}
    .answer-status.correct{color:#48bb78}
    .answer-status.incorrect{color:#f56565}
    .test-mode-selector{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
    .mode-button{padding:20px;border:2px solid #e2e8f0;border-radius:12px;background:#fff;cursor:pointer;transition:.15s;text-align:center}
    .mode-button:hover{border-color:#667eea;background:#f7fafc}
    .mode-button.selected{border-color:#667eea;background:#f0f4ff}
    .mode-title{font-size:18px;font-weight:700;color:#2d3748;margin-bottom:4px}
    .mode-desc{font-size:13px;color:#718096}
    @media (max-width:480px){
      .container{padding:20px}
      .question-text{font-size:18px}
      .score-display{font-size:52px}
      .test-mode-selector{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Home -->
    <div id="homeScreen">
      <h1>文法記述テスト</h1>
<p style=\"font-size: small; color: gray;\">ver.12</p>
      <p style="text-align:center;color:#718096;margin-bottom:20px;">高校英語文法 定義問題</p>
      <button class="button button-purple" onclick="startGrammarTest()">記述テストを開始</button>
      <button class="button button-orange" onclick="showPracticeMode()">練習モード</button>
      <button class="button button-green" onclick="showTeacherLogin()">教員ページ</button>
    </div>

    <!-- Settings -->
    <div id="settingsScreen" class="hidden">
      <h2>テスト設定</h2>
      
      <div class="form-group">
        <label>テストモード</label>
        <div class="test-mode-selector">
          <div class="mode-button selected" onclick="selectMode('test')" id="modeTest">
            <div class="mode-title">テストモード</div>
            <div class="mode-desc">時間制限あり・1回のみ解答</div>
          </div>
          <div class="mode-button" onclick="selectMode('practice')" id="modePractice">
            <div class="mode-title">練習モード</div>
            <div class="mode-desc">時間制限なし・即座に正解確認</div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>文法大項目の選択（複数選択可）</label>
        <div class="select-controls">
          <button class="select-button" onclick="selectAllMajorCategories()">全て選択</button>
          <button class="select-button" onclick="deselectAllMajorCategories()">全て解除</button>
        </div>
        <div class="checkbox-group" style="max-height:150px;overflow-y:auto;border:2px solid #e2e8f0;border-radius:8px;padding:12px;">
          <label class="checkbox-label" style="display:flex;align-items:center;padding:4px 0;cursor:pointer;font-size:14px;">
            <input type="checkbox" value="tense" onchange="updateSubCategories()" style="margin-right:8px;">
            時制（TENSE）
          </label>
          <label class="checkbox-label" style="display:flex;align-items:center;padding:4px 0;cursor:pointer;font-size:14px;">
            <input type="checkbox" value="voice" onchange="updateSubCategories()" style="margin-right:8px;">
            受動態（VOICE）
          </label>
          <label class="checkbox-label" style="display:flex;align-items:center;padding:4px 0;cursor:pointer;font-size:14px;">
            <input type="checkbox" value="auxiliary" onchange="updateSubCategories()" style="margin-right:8px;">
            助動詞（AUXILIARY VERB）
          </label>
          <label class="checkbox-label" style="display:flex;align-items:center;padding:4px 0;cursor:pointer;font-size:14px;">
            <input type="checkbox" value="infinitive" onchange="updateSubCategories()" style="margin-right:8px;">
            不定詞（INFINITIVE）
          </label>
          <label class="checkbox-label" style="display:flex;align-items:center;padding:4px 0;cursor:pointer;font-size:14px;">
            <input type="checkbox" value="gerund" onchange="updateSubCategories()" style="margin-right:8px;">
            動名詞（GERUND）
          </label>
          <label class="checkbox-label" style="display:flex;align-items:center;padding:4px 0;cursor:pointer;font-size:14px;">
            <input type="checkbox" value="participle" onchange="updateSubCategories()" style="margin-right:8px;">
            分詞（PARTICIPLE）
          </label>
          <label class="checkbox-label" style="display:flex;align-items:center;padding:4px 0;cursor:pointer;font-size:14px;">
            <input type="checkbox" value="subjunctive" onchange="updateSubCategories()" style="margin-right:8px;">
            仮定法（SUBJUNCTIVE）
          </label>
          <label class="checkbox-label" style="display:flex;align-items:center;padding:4px 0;cursor:pointer;font-size:14px;">
            <input type="checkbox" value="relative" onchange="updateSubCategories()" style="margin-right:8px;">
            関係詞（RELATIVE PRONOUN）
          </label>
          <label class="checkbox-label" style="display:flex;align-items:center;padding:4px 0;cursor:pointer;font-size:14px;">
            <input type="checkbox" value="comparison" onchange="updateSubCategories()" style="margin-right:8px;">
            比較（COMPARISON）
          </label>
        </div>
      </div>

      <div class="form-group">
        <label>文法小項目の選択（複数選択可）</label>
        <div class="select-controls">
          <button class="select-button" onclick="selectAllItems()">全て選択</button>
          <button class="select-button" onclick="deselectAllItems()">全て解除</button>
        </div>
        <div class="checkbox-group" id="subCategoryGroup" style="max-height:200px;overflow-y:auto;border:2px solid #e2e8f0;border-radius:8px;padding:12px;"></div>
      </div>

      <div class="form-group">
        <label>問題数</label>
        <select id="questionCount">
          <option value="3">3問</option>
          <option value="5">5問</option>
          <option value="10" selected>10問</option>
          <option value="all">全問題</option>
        </select>
      </div>

      <div class="form-group" id="timeLimitGroup">
        <label>制限時間</label>
        <select id="timeLimit">
          <option value="5">5分</option>
          <option value="10" selected>10分</option>
          <option value="15">15分</option>
          <option value="20">20分</option>
          <option value="0">無制限</option>
        </select>
      </div>

      <div id="studentInfoGroup">
        <div class="info-grid">
          <div class="form-group">
            <label>学年 <span style="color:#f56565;">*</span></label>
            <select id="studentGrade">
              <option value="">選択してください</option>
              <option value="1年">1年</option>
              <option value="2年">2年</option>
              <option value="3年">3年</option>
            </select>
          </div>
          <div class="form-group">
            <label>クラス <span style="color:#f56565;">*</span></label>
            <select id="studentClass">
              <option value="">選択してください</option>
            </select>
          </div>
        </div>
        <div class="info-grid">
          <div class="form-group">
            <label>出席番号 <span style="color:#f56565;">*</span></label>
            <select id="studentNumber">
              <option value="">選択してください</option>
            </select>
          </div>
          <div class="form-group">
            <label>氏名 <span style="color:#f56565;">*</span></label>
            <input type="text" id="studentName" placeholder="例: 山田太郎">
          </div>
        </div>
      </div>
      
      <button class="button button-blue" onclick="startTest()">テスト開始</button>
      <button class="button button-gray" onclick="backToHome()">戻る</button>
    </div>

    <!-- Quiz -->
    <div id="quizScreen" class="hidden">
      <div class="timer" id="timer"></div>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="quiz-container">
        <div class="question-box">
          <div class="question-header">
            <div class="question-number" id="questionNumber"></div>
            <div class="point-badge" id="pointBadge"></div>
          </div>
          <div class="question-title" id="questionTitle"></div>
          <div class="question-text" id="questionText"></div>
        </div>
        <div class="answer-section">
          <textarea class="answer-input" id="answerInput" placeholder="答えを入力してください..." rows="3"></textarea>
          <div class="answer-status" id="answerStatus"></div>
          <div class="model-answer" id="modelAnswer">
            <div class="model-answer-label">模範解答</div>
            <div class="model-answer-text" id="modelAnswerText"></div>
          </div>
        </div>
      </div>
      <button class="button button-blue" id="submitButton" onclick="submitAnswer()">解答を提出</button>
      <button class="button button-blue hidden" id="nextButton" onclick="nextQuestion()">次の問題へ</button>
      <button class="button button-orange hidden" id="finishButton" onclick="finishTest()">テストを終了</button>
    </div>

    <!-- Result -->
    <div id="resultScreen" class="hidden">
      <h2>テスト終了！</h2>
      <div class="score-display" id="scoreDisplay"></div>
      <div class="result-details">
        <div class="result-item">
          <span class="result-label">正解数</span>
          <span class="result-value" id="correctCount"></span>
        </div>
        <div class="result-item">
          <span class="result-label">問題数</span>
          <span class="result-value" id="totalCount"></span>
        </div>
        <div class="result-item">
          <span class="result-label">所要時間</span>
          <span class="result-value" id="elapsedTime"></span>
        </div>
      </div>
      <div id="saveSuccess" class="success-box" style="display:none;">
        <strong>✅ 保存完了</strong><br>成績がクラウドに保存されました。
      </div>
      <div id="detailedResults"></div>
      <button class="button button-blue" onclick="restartTest()">もう一度挑戦</button>
      <button class="button button-gray" onclick="backToHome()">メニューに戻る</button>
    </div>

    <!-- Teacher Login -->
    <div id="teacherLoginScreen" class="hidden">
      <h2>教員ページログイン</h2>
      <div class="form-group">
        <label>パスワード</label>
        <input type="password" id="teacherPassword" placeholder="パスワードを入力">
      </div>
      <button class="button button-green" onclick="teacherLogin()">ログイン</button>
      <button class="button button-gray" onclick="backToHome()">戻る</button>
    </div>

    <!-- Teacher Page -->
    <div id="teacherScreen" class="hidden">
      <h2>成績管理</h2>
      <div id="scoresList" style="max-height:400px;overflow-y:auto;">
        <p style="text-align:center;color:#718096;">まだ成績データがありません</p>
      </div>
      <button class="button button-blue" onclick="loadCloudScores()" style="margin-top:10px;">クラウドから読み込み</button>
      <button class="button button-green" onclick="exportScores()" style="margin-top:10px;">CSVでエクスポート</button>
      <button class="button button-red" onclick="clearAllScores()" style="margin-top:20px;">すべてのデータを削除</button>
      <button class="button button-gray" onclick="backToHome()">戻る</button>
    </div>
  </div>

  <script>
    // ====== グローバル状態 ======
    let grammarQuestions = [];
    let currentQuestions = [];
    let currentQuestion = 0;
    let score = 0;
    let studentScores = [];
    let currentStudentInfo = null;
    let testMode = 'test';
    let userAnswers = [];
    let startTime = null;
    let timerInterval = null;
    let timeLimit = 10;
    let selectedCategories = [];

    // ====== GAS設定 ======
    const GAS_URL = 'https://script.google.com/macros/s/AKfycby2LlbbgoOcQe9akIQ7Jegs5qiNqbsbqt23JfNHiKNMSotld7gjSDAPz-K-2gekC8viHw/exec';

    // ====== 文法データの定義 ======
    const grammarData = {
      tense: {
        name: "時制（TENSE）",
        items: [
          {id: "001", name: "基本３時制の定義"},
          {id: "002", name: "様々な未来表現"},
          {id: "003", name: "進行形の定義"},
          {id: "004", name: "進行形のルール"},
          {id: "005", name: "「時や条件」を表す副詞節で用いる現在形"},
          {id: "006", name: "現在完了形の用法①～完了・結果・経験～"},
          {id: "007", name: "現在完了形の用法②～継続～"},
          {id: "008", name: "現在完了形の用法③～注意点～"},
          {id: "009", name: "過去完了形の用法①～完了・結果・経験～"},
          {id: "010", name: "過去完了形の用法②～継続～"},
          {id: "011", name: "過去完了形の用法③～大過去～"},
          {id: "012", name: "未来完了形の用法①～完了・結果・経験と継続～"},
          {id: "013", name: "未来完了形の用法②～注意点～"}
        ]
      },
      voice: {
        name: "受動態（VOICE）",
        items: [
          {id: "014", name: "受動態の基本"},
          {id: "015", name: "様々な形の受動態"},
          {id: "016", name: "受動態の疑問文"},
          {id: "017", name: "第４文型の受動態"},
          {id: "018", name: "第５文型の受動態"},
          {id: "019", name: "思考認知告示動詞の受動態"},
          {id: "020", name: "注意すべき受動態の表現①～be known～"},
          {id: "021", name: "注意すべき受動態の表現②～感情表現～"},
          {id: "022", name: "注意すべき受動態の表現③～被害表現～"},
          {id: "023", name: "注意すべき受動態の表現④～その他の頻出表現～"},
          {id: "024", name: "be動詞の代わりに使える「動作動詞」と「状態動詞」"},
          {id: "025", name: "注意すべき受動態の表現⑤～受動態を使わない表現～"},
          {id: "026", name: "群動詞（熟語）の受動態"}
        ]
      },
      auxiliary: {
        name: "助動詞（AUXILIARY VERB）",
        items: [
          {id: "027", name: "canの基本"},
          {id: "028", name: "couldを理解しよう"},
          {id: "029", name: "mayの基本"},
          {id: "030", name: "mightの基本"},
          {id: "031", name: "mustの基本"},
          {id: "032", name: "mustとhave toの違いを理解しよう"},
          {id: "033", name: "shouldの基本"},
          {id: "034", name: "shouldの仲間①ought toV"},
          {id: "035", name: "shouldの仲間②had better V原形"},
          {id: "036", name: "willの基本"},
          {id: "037", name: "wouldの基本"},
          {id: "038", name: "used to V原形～の基本"},
          {id: "039", name: "shallの基本"},
          {id: "040", name: "needの基本"},
          {id: "041", name: "助動詞 have Vp.p.シリーズ"},
          {id: "042", name: "慣用表現シリーズ"},
          {id: "043", name: "that節で用いられる想念のshould①"},
          {id: "044", name: "that節で用いられる想念のshould②"}
        ]
      },
      infinitive: {
        name: "不定詞（INFINITIVE）",
        items: [
          {id: "045", name: "不定詞の基本① 名詞的用法"},
          {id: "046", name: "不定詞の基本② 形容詞的用法"},
          {id: "047", name: "不定詞の基本③ 副詞的用法"},
          {id: "048", name: "ＳＶＯ＋toＶ～"},
          {id: "049", name: "不定詞の意味上の主語①"},
          {id: "050", name: "不定詞の意味上の主語②"},
          {id: "051", name: "使役動詞（原形不定詞）"},
          {id: "052", name: "知覚動詞"},
          {id: "053", name: "～ようだシリーズ"},
          {id: "054", name: "時制の不一致"},
          {id: "055", name: "様々な形の不定詞～進行形・受動態・否定～"},
          {id: "056", name: "疑問詞 toV～シリーズ"},
          {id: "057", name: "独立不定詞"},
          {id: "058", name: "be to 不定詞"},
          {id: "059", name: "難易度を表す形容詞＋ toV～"},
          {id: "060", name: "代不定詞"},
          {id: "061", name: "不定詞の熟語①"},
          {id: "062", name: "不定詞の熟語②"}
        ]
      },
      gerund: {
        name: "動名詞（GERUND）",
        items: [
          {id: "063", name: "動名詞の基本"},
          {id: "064", name: "動名詞と不定詞の違い"},
          {id: "065", name: "動名詞の意味上の主語と否定語の位置"},
          {id: "066", name: "動名詞の受動態"},
          {id: "067", name: "時制の不一致"},
          {id: "068", name: "動名詞を使った重要表現①"},
          {id: "069", name: "動名詞を使った重要表現②"},
          {id: "070", name: "動名詞と不定詞①"},
          {id: "071", name: "動名詞と不定詞②"},
          {id: "072", name: "動名詞と不定詞③"}
        ]
      },
      participle: {
        name: "分詞（PARTICIPLE）",
        items: [
          {id: "073", name: "現在分詞の基本"},
          {id: "074", name: "過去分詞の基本"},
          {id: "075", name: "補語になる分詞（第２文型）"},
          {id: "076", name: "補語になる分詞（第５文型）①"},
          {id: "077", name: "補語になる分詞（第５文型）②"},
          {id: "078", name: "分詞構文の基本"},
          {id: "079", name: "分詞構文の作り方"},
          {id: "080", name: "分詞構文の和訳"},
          {id: "081", name: "時制の不一致＆独立分詞構文"},
          {id: "082", name: "接続詞を省略しない分詞構文"},
          {id: "083", name: "慣用的な分詞構文"},
          {id: "084", name: "付帯状況を表すwith"},
          {id: "085", name: "形容詞になっちまった分詞"}
        ]
      },
      subjunctive: {
        name: "仮定法（SUBJUNCTIVE）",
        items: [
          {id: "086", name: "直接法と仮定法"},
          {id: "087", name: "仮定法過去（現在の妄想）"},
          {id: "088", name: "仮定法過去完了（過去の妄想）"},
          {id: "089", name: "wishとas ifを用いた仮定法"},
          {id: "090", name: "未来の妄想"},
          {id: "091", name: "ifの省略"},
          {id: "092", name: "if節を使わない仮定法表現"},
          {id: "093", name: "仮定法を使った慣用表現"},
          {id: "094", name: "仮定法ミックス（過去に～だったら、いま…なのになぁ）"}
        ]
      },
      relative: {
        name: "関係詞（RELATIVE PRONOUN）",
        items: [
          {id: "095", name: "関係代名詞の基本"},
          {id: "096", name: "関係代名詞that"},
          {id: "097", name: "前置詞と関係代名詞"},
          {id: "098", name: "関係副詞when"},
          {id: "099", name: "関係副詞whyとhow"},
          {id: "100", name: "先行詞を省略できるケース"},
          {id: "101", name: "関係詞の非制限用法"},
          {id: "102", name: "非制限用法の使い方"},
          {id: "103", name: "関係副詞where"},
          {id: "104", name: "関係詞代名詞what"},
          {id: "105", name: "関係詞代名詞whatを用いた慣用表現"},
          {id: "106", name: "複合関係詞の概要"},
          {id: "107", name: "副詞節（譲歩）を作る複合関係代名詞①"},
          {id: "108", name: "副詞節（譲歩）を作る複合関係代名詞②"},
          {id: "109", name: "名詞節を作る複合関係代名詞"},
          {id: "110", name: "関係代名詞としてのthanとbut"},
          {id: "111", name: "関係代名詞としてのas"},
          {id: "112", name: "マニア向け関係代名詞"}
        ]
      },
      comparison: {
        name: "比較（COMPARISON）",
        items: [
          {id: "113", name: "原級比較の基本"},
          {id: "114", name: "asの倍数表現"},
          {id: "115", name: "asを用いた慣用表現①"},
          {id: "116", name: "asを用いた慣用表現②"},
          {id: "117", name: "asを用いた慣用表現③"},
          {id: "118", name: "比較級の基本"},
          {id: "119", name: "差を具体的に表す比較級"},
          {id: "120", name: "比較級の倍数表現"},
          {id: "121", name: "不規則変化する形容詞・副詞"},
          {id: "122", name: "lessを用いた比較級"},
          {id: "123", name: "比較級を用いた慣用表現①"},
          {id: "124", name: "比較級を用いた慣用表現②"},
          {id: "125", name: "比較級を用いた慣用表現③"},
          {id: "126", name: "比較級を用いた慣用表現④"},
          {id: "127", name: "noを使った比較表現①"},
          {id: "128", name: "noを使った比較表現②"},
          {id: "129", name: "最上級の基本"},
          {id: "130", name: "最上級を用いた表現①"},
          {id: "131", name: "最上級を用いた表現②"},
          {id: "132", name: "最上級の意味を表す原級・比較表現"}
        ]
      }
    };

    // ====== 問題データ ======
    let questionData = [];

    // ====== ユーティリティ ======
    function showScreen(id){
      ['homeScreen','settingsScreen','quizScreen','resultScreen','teacherLoginScreen','teacherScreen']
        .forEach(sid=>document.getElementById(sid).classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    function backToHome(){
      showScreen('homeScreen');
      resetQuizState();
    }

    function resetQuizState(){
      currentQuestion=0;
      score=0;
      currentQuestions=[];
      userAnswers=[];
      testMode='test';
      selectedCategories=[];
      if(timerInterval) clearInterval(timerInterval);
    }

    // ====== セレクト初期化 ======
    function initializeSelects(){
      const classSelect=document.getElementById('studentClass');
      const numberSelect=document.getElementById('studentNumber');
      if(classSelect && classSelect.options.length<=1){
        for(let i=1;i<=10;i++){
          const o=document.createElement('option');
          o.value=i+'組';
          o.textContent=i+'組';
          classSelect.appendChild(o);
        }
      }
      if(numberSelect && numberSelect.options.length<=1){
        for(let i=1;i<=40;i++){
          const o=document.createElement('option');
          o.value=i+'番';
          o.textContent=i+'番';
          numberSelect.appendChild(o);
        }
      }
    }

    // ====== カテゴリ選択 ======
    function selectAllMajorCategories(){
      const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]');
      checkboxes.forEach(cb => {
        if(['tense','voice','auxiliary','infinitive','gerund','participle','subjunctive','relative','comparison'].includes(cb.value)){
          cb.checked = true;
        }
      });
      updateSubCategories();
    }

    function deselectAllMajorCategories(){
      const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]');
      checkboxes.forEach(cb => {
        if(['tense','voice','auxiliary','infinitive','gerund','participle','subjunctive','relative','comparison'].includes(cb.value)){
          cb.checked = false;
        }
      });
      updateSubCategories();
    }

    function updateSubCategories(){
      const checkedMajorCategories = [];
      const majorCheckboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked');
      majorCheckboxes.forEach(cb => {
        if(['tense','voice','auxiliary','infinitive','gerund','participle','subjunctive','relative','comparison'].includes(cb.value)){
          checkedMajorCategories.push(cb.value);
        }
      });

      const subCategoryGroup = document.getElementById('subCategoryGroup');
      subCategoryGroup.innerHTML = '';

      if(checkedMajorCategories.length === 0){
        // 何も選択されていない場合は全て表示
        Object.keys(grammarData).forEach(key => {
          displayCategoryItems(key, subCategoryGroup);
        });
      } else {
        // 選択されたカテゴリのみ表示
        checkedMajorCategories.forEach(key => {
          displayCategoryItems(key, subCategoryGroup);
        });
      }
    }

    function displayCategoryItems(key, container){
      const category = grammarData[key];
      if(!category) return;
      
      const header = document.createElement('div');
      header.style.fontWeight = '700';
      header.style.color = '#667eea';
      header.style.marginTop = '12px';
      header.style.marginBottom = '4px';
      header.style.fontSize = '15px';
      header.textContent = category.name;
      container.appendChild(header);

      category.items.forEach(item => {
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.padding = '4px 0';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.innerHTML = `
          <input type="checkbox" value="${item.id}" onchange="updateSelectedCategories()" style="margin-right:8px;">
          ${item.id}. ${item.name}
        `;
        container.appendChild(label);
      });
    }

    function selectAllItems(){
      const checkboxes = document.querySelectorAll('#subCategoryGroup input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = true);
      updateSelectedCategories();
    }

    function deselectAllItems(){
      const checkboxes = document.querySelectorAll('#subCategoryGroup input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = false);
      updateSelectedCategories();
    }

    function updateSelectedCategories(){
      selectedCategories = [];
      const checkboxes = document.querySelectorAll('#subCategoryGroup input[type="checkbox"]:checked');
      checkboxes.forEach(cb => selectedCategories.push(cb.value));
    }

    // ====== モード選択 ======
    function selectMode(mode){
      testMode = mode;
      document.getElementById('modeTest').classList.toggle('selected', mode === 'test');
      document.getElementById('modePractice').classList.toggle('selected', mode === 'practice');
      
      // 練習モードでは時間制限と学生情報を非表示
      document.getElementById('timeLimitGroup').style.display = mode === 'practice' ? 'none' : 'block';
      document.getElementById('studentInfoGroup').style.display = mode === 'practice' ? 'none' : 'block';
    }

    function showPracticeMode(){
      showScreen('settingsScreen');
      selectMode('practice');
      // 初期状態で全カテゴリを表示
      setTimeout(() => {
        updateSubCategories();
      }, 100);
    }

    // ====== テスト開始 ======
    function startGrammarTest(){
      showScreen('settingsScreen');
      selectMode('test');
      // 初期状態で全カテゴリを表示
      setTimeout(() => {
        updateSubCategories();
      }, 100);
    }

    function startTest(){
      // テストモードの場合のみ学生情報を検証
      if(testMode === 'test'){
        const grade = document.getElementById('studentGrade').value;
        const studentClass = document.getElementById('studentClass').value;
        const number = document.getElementById('studentNumber').value;
        const name = document.getElementById('studentName').value;

        if(!grade || !studentClass || !number || !name){
          alert('学年・クラス・出席番号・氏名をすべて入力してください。');
          return;
        }
        currentStudentInfo = { grade, class: studentClass, number, name };
      }

      // カテゴリが選択されているか確認
      if(selectedCategories.length === 0){
        alert('文法小項目を1つ以上選択してください。');
        return;
      }

      // スコアをリセット
      score = 0;
      currentQuestion = 0;

      // 問題生成
      generateQuestions();
      
      if(currentQuestions.length === 0){
        alert('選択した項目に問題が用意されていません。');
        return;
      }

      // タイマー設定
      if(testMode === 'test'){
        timeLimit = parseInt(document.getElementById('timeLimit').value);
        startTime = Date.now();
        if(timeLimit > 0) startTimer();
      }

      showScreen('quizScreen');
      displayQuestion();
    }

    function generateQuestions(){
      const count = document.getElementById('questionCount').value;
      
      // 選択されたカテゴリの問題のみ抽出
      let filteredQuestions = questionData.filter(q => 
        selectedCategories.includes(q.id)
      );
      
      // 問題が存在しない場合は全問題を使用（デモ用）
      if(filteredQuestions.length === 0){
        console.log('選択されたカテゴリに問題がありません。全問題を使用します。');
        filteredQuestions = [...questionData];
      }
      
      let shuffled = [...filteredQuestions].sort(() => Math.random() - 0.5);
      
      if(count === 'all'){
        currentQuestions = shuffled;
      } else {
        currentQuestions = shuffled.slice(0, parseInt(count));
      }
      
      // 各問題に answered フラグを初期化
      currentQuestions = currentQuestions.map(q => ({
        ...q,
        answered: false,
        isCorrect: false
      }));
      
      userAnswers = new Array(currentQuestions.length).fill('');
    }

    function startTimer(){
      const updateTimer = () => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const remaining = timeLimit * 60 - elapsed;
        
        if(remaining <= 0){
          clearInterval(timerInterval);
          alert('制限時間になりました。テストを終了します。');
          finishTest();
          return;
        }
        
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        document.getElementById('timer').textContent = 
          `残り時間: ${minutes}:${seconds.toString().padStart(2, '0')}`;
      };
      
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
    }

    function displayQuestion(){
      if(currentQuestion >= currentQuestions.length){
        finishTest();
        return;
      }

      const q = currentQuestions[currentQuestion];
      document.getElementById('questionNumber').textContent = `問${currentQuestion + 1} / ${currentQuestions.length}`;
      document.getElementById('pointBadge').textContent = q.point;
      document.getElementById('questionTitle').textContent = q.title;
      document.getElementById('questionText').textContent = q.question;
      
      // 前の解答があれば表示
      document.getElementById('answerInput').value = userAnswers[currentQuestion] || '';
      document.getElementById('answerInput').className = 'answer-input';
      document.getElementById('answerStatus').textContent = '';
      document.getElementById('modelAnswer').style.display = 'none';
      
      // ボタンの表示制御
      const isLastQuestion = currentQuestion === currentQuestions.length - 1;
      
      if(testMode === 'practice' || testMode === 'test'){
        document.getElementById('submitButton').classList.remove('hidden');
        document.getElementById('nextButton').classList.toggle('hidden', testMode === 'practice' || !isLastQuestion);
        document.getElementById('finishButton').classList.toggle('hidden', testMode === 'practice' || isLastQuestion === false);
      }

      document.getElementById('progressFill').style.width = 
        (((currentQuestion + 1) / currentQuestions.length) * 100) + '%';
      
      // タイマー表示
      document.getElementById('timer').style.display = 
        (testMode === 'test' && timeLimit > 0) ? 'block' : 'none';
    }

    function submitAnswer(){
      const userAnswer = document.getElementById('answerInput').value.trim();
      const q = currentQuestions[currentQuestion];
      
      userAnswers[currentQuestion] = userAnswer;
      
      // 正解判定（部分一致も考慮）
      const isCorrect = checkAnswer(userAnswer, q.answer);
      
      if(isCorrect){
        document.getElementById('answerInput').className = 'answer-input correct';
        document.getElementById('answerStatus').textContent = '✓ 正解！';
        document.getElementById('answerStatus').className = 'answer-status correct';
        score++;
      } else {
        document.getElementById('answerInput').className = 'answer-input incorrect';
        document.getElementById('answerStatus').textContent = '✗ 不正解';
        document.getElementById('answerStatus').className = 'answer-status incorrect';
      }
      
      // 模範解答を表示
      document.getElementById('modelAnswerText').textContent = q.answer;
      document.getElementById('modelAnswer').style.display = 'block';
      
      // ボタンの切り替え
      document.getElementById('submitButton').classList.add('hidden');
      if(currentQuestion < currentQuestions.length - 1){
        document.getElementById('nextButton').classList.remove('hidden');
      } else {
        document.getElementById('finishButton').classList.remove('hidden');
      }
    }

    function checkAnswer(userAnswer, correctAnswer){
      // 空の解答は不正解
      if(!userAnswer || userAnswer.trim() === '') return false;
      
      // 前処理：大文字小文字を区別せず、余分な空白を削除
      const normalizeText = (text) => {
        return text.toLowerCase()
          .replace(/[、。！？「」『』（）｛｝［］【】・]/g, ' ') // 句読点を空白に
          .replace(/\s+/g, ' ') // 連続する空白を1つに
          .trim();
      };
      
      const normalizedUser = normalizeText(userAnswer);
      const normalizedCorrect = normalizeText(correctAnswer);
      
      // 完全一致
      if(normalizedUser === normalizedCorrect) return true;
      
      // 番号付きリストの特別処理（①②③などがある場合）
      if(correctAnswer.includes('①') || correctAnswer.includes('②')) {
        // 番号付きの項目を抽出
        const correctItems = correctAnswer.match(/[①-⑩]\s*[^①-⑩]*/g) || [];
        const extractedCorrectItems = correctItems.map(item => {
          return item.replace(/[①-⑩]/g, '').trim().toLowerCase();
        });
        
        // ユーザーの解答から項目を抽出（様々な区切り文字に対応）
        const userItems = userAnswer.split(/[,、\n①-⑩123456789０-９]/).filter(item => item.trim());
        const normalizedUserItems = userItems.map(item => item.trim().toLowerCase());
        
        // 項目の一致率を計算
        let matchCount = 0;
        extractedCorrectItems.forEach(correctItem => {
          const found = normalizedUserItems.some(userItem => {
            // 部分一致または類似度チェック
            return userItem.includes(correctItem) || 
                   correctItem.includes(userItem) ||
                   calculateSimilarity(userItem, correctItem) > 0.7;
          });
          if(found) matchCount++;
        });
        
        // 60%以上の項目が一致していれば正解
        if(extractedCorrectItems.length > 0) {
          return matchCount / extractedCorrectItems.length >= 0.6;
        }
      }
      
      // キーワードベースの判定
      const extractKeywords = (text) => {
        // 日本語と英語のキーワードを抽出
        const keywords = text.match(/[ぁ-んァ-ヶー一-龠]+|[a-zA-Z]+/g) || [];
        // 2文字以上のキーワードのみを使用（助詞などを除外）
        return keywords.filter(kw => kw.length >= 2);
      };
      
      const correctKeywords = extractKeywords(normalizedCorrect);
      const userKeywords = extractKeywords(normalizedUser);
      
      if(correctKeywords.length === 0) return false;
      
      // 各正解キーワードに対して、ユーザーの解答に含まれているかチェック
      let keywordMatches = 0;
      let importantKeywordMatches = 0;
      
      // 重要なキーワードを定義（これらは必須）
      const importantPatterns = [
        /過去|現在|未来|完了|進行/,
        /public|private|公的|私的/,
        /状態動詞|動作動詞/,
        /継続|完了|結果|経験/,
        /will|going\s*to/i
      ];
      
      correctKeywords.forEach(keyword => {
        const isImportant = importantPatterns.some(pattern => pattern.test(keyword));
        
        // ユーザーの解答に含まれているかチェック
        const found = userKeywords.some(userKw => {
          // 完全一致
          if(userKw === keyword) return true;
          // 部分一致（3文字以上の場合）
          if(keyword.length >= 3 && (userKw.includes(keyword) || keyword.includes(userKw))) return true;
          // 類似度チェック
          return calculateSimilarity(userKw, keyword) > 0.8;
        });
        
        if(found) {
          keywordMatches++;
          if(isImportant) importantKeywordMatches++;
        } else if(isImportant) {
          // 重要なキーワードが見つからない場合はペナルティ
          keywordMatches -= 0.5;
        }
      });
      
      // 判定：キーワードの60%以上が一致していれば正解
      const matchRate = keywordMatches / correctKeywords.length;
      
      // 短い解答（10文字未満）の場合は厳しく判定
      if(normalizedUser.length < 10) {
        return matchRate >= 0.8;
      }
      
      // 通常の判定
      return matchRate >= 0.6;
    }
    
    // 文字列の類似度を計算（レーベンシュタイン距離の簡易版）
    function calculateSimilarity(str1, str2) {
      const longer = str1.length > str2.length ? str1 : str2;
      const shorter = str1.length > str2.length ? str2 : str1;
      
      if (longer.length === 0) return 1.0;
      
      const editDistance = getEditDistance(longer, shorter);
      return (longer.length - editDistance) / longer.length;
    }
    
    // 編集距離を計算
    function getEditDistance(str1, str2) {
      const matrix = [];
      
      for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
      }
      
      for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
      }
      
      for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
          if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1, // 置換
              matrix[i][j - 1] + 1,     // 挿入
              matrix[i - 1][j] + 1      // 削除
            );
          }
        }
      }
      
      return matrix[str2.length][str1.length];
    }

    function nextQuestion(){
      // テストモードの場合は解答を保存
      if(testMode === 'test'){
        const userAnswer = document.getElementById('answerInput').value.trim();
        userAnswers[currentQuestion] = userAnswer;
      }
      
      currentQuestion++;
      displayQuestion();
    }

    function finishTest(){
      if(timerInterval) clearInterval(timerInterval);
      
      // テストモードで未解答の問題を保存
      if(testMode === 'test'){
        const userAnswer = document.getElementById('answerInput').value.trim();
        userAnswers[currentQuestion] = userAnswer;
        
        // 採点
        score = 0;
        currentQuestions.forEach((q, i) => {
          if(checkAnswer(userAnswers[i], q.answer)){
            score++;
          }
        });
      }
      
      showResult();
    }

    function showResult(){
      const percentage = Math.round((score / currentQuestions.length) * 100);
      document.getElementById('scoreDisplay').textContent = percentage + '%';
      document.getElementById('correctCount').textContent = `${score}問`;
      document.getElementById('totalCount').textContent = `${currentQuestions.length}問`;
      
      // 所要時間
      if(startTime){
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('elapsedTime').textContent = 
          `${minutes}分${seconds}秒`;
      } else {
        document.getElementById('elapsedTime').textContent = '-';
      }
      
      // 詳細結果（両モード共通で表示）
      let detailHtml = '<h3 style="margin-top:20px;">解答詳細</h3>';
      currentQuestions.forEach((q, i) => {
        const isCorrect = q.isCorrect !== undefined ? q.isCorrect : checkAnswer(userAnswers[i], q.answer);
        detailHtml += `
          <div style="margin:10px 0;padding:10px;background:${isCorrect ? '#f0fff4' : '#fff5f5'};border-radius:8px;">
            <div style="font-weight:600;color:#2d3748;">問${i+1}. ${q.question}</div>
            <div style="color:#4a5568;margin-top:4px;">あなたの解答: ${userAnswers[i] || '（未解答）'}</div>
            <div style="color:${isCorrect ? '#48bb78' : '#f56565'};margin-top:4px;">
              ${isCorrect ? '✓ 正解' : '✗ 不正解　正解: ' + q.answer}
            </div>
          </div>
        `;
      });
      document.getElementById('detailedResults').innerHTML = detailHtml;

      // 成績保存（テストモードのみ）
      if(testMode === 'test' && currentStudentInfo){
        const newScore = {
          ...currentStudentInfo,
          score,
          total: currentQuestions.length,
          percentage,
          date: new Date().toLocaleString('ja-JP'),
          timeLimit: timeLimit,
          elapsedTime: startTime ? Math.floor((Date.now() - startTime) / 1000) : 0
        };
        studentScores.push(newScore);
        saveData();
        autoSendResult(newScore);
      }

      showScreen('resultScreen');
    }

    function restartTest(){
      resetQuizState();
      startGrammarTest();
    }

    // ====== 教員ページ ======
    function showTeacherLogin(){
      const pw = document.getElementById('teacherPassword');
      if(pw) pw.value = '';
      showScreen('teacherLoginScreen');
    }

    function teacherLogin(){
      const password = document.getElementById('teacherPassword').value;
      if(password === '1611'){
        showTeacherPage();
      } else {
        alert('パスワードが間違っています');
      }
    }

    function showTeacherPage(){
      const list = document.getElementById('scoresList');
      if(studentScores.length === 0){
        list.innerHTML = '<p style="text-align:center;color:#718096;">まだ成績データがありません</p>';
      } else {
        let html = '<table style="width:100%;border-collapse:collapse"><tr style="background:#f7fafc">'
          + '<th style="padding:10px;border:1px solid #e2e8f0;">日時</th>'
          + '<th style="padding:10px;border:1px solid #e2e8f0;">氏名</th>'
          + '<th style="padding:10px;border:1px solid #e2e8f0;">学年</th>'
          + '<th style="padding:10px;border:1px solid #e2e8f0;">得点</th></tr>';
        
        studentScores.forEach(s => {
          html += `<tr>
            <td style="padding:10px;border:1px solid #e2e8f0;">${s.date}</td>
            <td style="padding:10px;border:1px solid #e2e8f0;">${s.name}</td>
            <td style="padding:10px;border:1px solid #e2e8f0;">${s.grade} ${s.class} ${s.number}</td>
            <td style="padding:10px;border:1px solid #e2e8f0;">${s.percentage}% (${s.score}/${s.total})</td>
          </tr>`;
        });
        html += '</table>';
        list.innerHTML = html;
      }
      showScreen('teacherScreen');
    }

    function exportScores(){
      if(studentScores.length === 0){
        alert('エクスポートする成績データがありません');
        return;
      }
      let csv = '日時,氏名,学年,クラス,出席番号,得点率,正解数,問題数\n';
      studentScores.forEach(s => {
        csv += `"${s.date}","${s.name}","${s.grade}","${s.class}","${s.number}",${s.percentage}%,${s.score},${s.total}\n`;
      });
      
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const blob = new Blob([bom, csv], {type: 'text/csv;charset=utf-8'});
      const link = document.createElement('a');
      const date = new Date().toISOString().slice(0, 10);
      link.download = `grammar_scores_${date}.csv`;
      link.href = URL.createObjectURL(blob);
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function clearAllScores(){
      if(confirm('本当にすべてのデータを削除しますか？\nこの操作は取り消せません。')){
        const dp = prompt('削除パスワード「9999」を入力してください：');
        if(dp === '9999'){
          studentScores = [];
          saveData();
          alert('すべてのデータを削除しました');
          showTeacherPage();
        } else {
          alert('パスワードが違います');
        }
      }
    }

    async function loadCloudScores(){
      const scores = await getScoresFromCloud();
      if(scores.length > 0){
        scores.forEach(cs => {
          const exists = studentScores.some(ls => 
            ls.date === cs.date && ls.name === cs.name
          );
          if(!exists){
            studentScores.push(cs);
          }
        });
        saveData();
        alert(`クラウドから${scores.length}件の成績を読み込みました`);
        showTeacherPage();
      } else {
        alert('クラウドに成績データがありません');
      }
    }

    // ====== ローカル保存 ======
    function loadData(){
      try {
        const saved = localStorage.getItem('grammarDescriptionTestData');
        if(saved){
          const data = JSON.parse(saved);
          studentScores = data.studentScores || [];
        }
      } catch(e){
        console.warn('loadData failed', e);
      }
    }

    function saveData(){
      const data = { studentScores };
      localStorage.setItem('grammarDescriptionTestData', JSON.stringify(data));
    }

    // ====== クラウド連携 ======
    function saveScoreToCloud(scoreData){
      return new Promise((resolve) => {
        try{
          if(!scoreData.reqId){
            scoreData.reqId = (Date.now().toString(36) + Math.random().toString(36).slice(2,8));
          }
          const params = new URLSearchParams(scoreData);
          const url = GAS_URL + '?' + params.toString();

          if (typeof navigator !== 'undefined' && navigator && navigator.onLine === false){
            resolve(false);
            return;
          }

          if (typeof fetch === 'function'){
            try{
              fetch(url, { mode: 'no-cors', keepalive: true })
                .then(()=> resolve(true))
                .catch(()=> {
                  try{
                    const img = new Image();
                    img.onload = () => resolve(true);
                    img.onerror = () => resolve(true);
                    img.src = url + '&_img=1&_ts=' + Date.now();
                    setTimeout(()=> resolve(true), 2500);
                  }catch(_){
                    resolve(true);
                  }
                });
              return;
            }catch(_){}
          }

          try{
            const img = new Image();
            img.onload = () => resolve(true);
            img.onerror = () => resolve(true);
            img.src = url + '&_img=1&_ts=' + Date.now();
            setTimeout(()=> resolve(true), 2500);
          }catch(_){
            resolve(false);
          }
        }catch(e){
          resolve(false);
        }
      });
    }

    async function getScoresFromCloud(){
      try{
        const res = await fetch(GAS_URL + '?action=getAll');
        const data = await res.json();
        if(data.success){
          return data.scores;
        }
        console.error('データ取得エラー:', data.error);
        return [];
      }catch(e){
        console.error('通信エラー:', e);
        return [];
      }
    }

    let hasSentToCloud = false;

    function autoSendResult(newScore) {
      if (!hasSentToCloud) {
        hasSentToCloud = true;
        const payload = {
          action: 'save',
          date: newScore.date,
          name: newScore.name,
          grade: newScore.grade,
          class: newScore.class,
          number: newScore.number,
          percentage: newScore.percentage,
          score: newScore.score,
          total: newScore.total,
          elapsedTime: newScore.elapsedTime
        };
        
        saveScoreToCloud(payload).then((ok) => {
          const success = document.getElementById('saveSuccess');
          if (ok && success) {
            success.style.display = 'block';
          }
        });
      }
      setTimeout(() => { hasSentToCloud = false; }, 3000);
    }

    // ====== 初期化 ======
    window.addEventListener('DOMContentLoaded', () => {
      initializeSelects();
      loadData();
      
      // CSVファイルから問題を読み込む
      loadQuestionsFromCSV();
    });

    // CSVファイルから問題を読み込む関数
    async function loadQuestionsFromCSV() {
      try {
        const response = await fetch('grammar_definition.csv');
        const csvContent = await response.text();

        const lines = csvContent.split('\n');
        const parsed = [];

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          const matches = line.match(/(\d+),(.*?),(.*?),(.*?),(.*)$/);
          if (matches && matches.length > 5) {
            parsed.push({
              id: matches[1].padStart(3, '0'),
              question: matches[2],
              answer: matches[3],
              point: matches[4],
              title: matches[5]
            });
          }
        }

        if (parsed.length > 0) {
          questionData = parsed;
              
        const order = document.getElementById('questionOrder')?.value;
        if (order === 'shuffle') {
          for (let i = questionData.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [questionData[i], questionData[j]] = [questionData[j], questionData[i]];
          }
        }

    console.log(`CSVから${parsed.length}問の問題を読み込みました`);
        }
      } catch (error) {
            console.error('CSVファイルの読み込みに失敗しました。', error);
      }
    }  
document.getElementById('showProblemsBtn').addEventListener('click', () => {
  const container = document.getElementById('problemListView');
  container.innerHTML = '';
  container.style.display = 'block';

  if (!questionData || questionData.length === 0) {
    container.innerHTML = '<p>⚠️ 問題が読み込まれていません。</p>';
    return;
  }

  const table = document.createElement('table');
  table.border = '1';
  table.style.borderCollapse = 'collapse';
  table.innerHTML = '<tr><th>ID</th><th>POINT</th><th>タイトル</th><th>問題</th></tr>';

  questionData.forEach(q => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${q.id}</td><td>${q.point}</td><td>${q.title}</td><td>${q.question}</td>`;
    table.appendChild(row);
  });

  container.appendChild(table);
});

</script>

  <hr>
  


  <div id="problemListView" style="display:none; padding: 10px; border: 1px solid #ccc; margin-top: 10px;"></div>


<script>
document.addEventListener("DOMContentLoaded", function () {
  const labelNode = Array.from(document.querySelectorAll("label")).find(el => el.textContent.includes("問題数"));
  if (labelNode) {
    const orderDiv = document.createElement("div");
    orderDiv.innerHTML = `
      <div class="order-select" style="margin: 10px 0;">
        <label for="questionOrder">出題順:</label>
        <select id="questionOrder">
          <option value="sequential">順番通り</option>
          <option value="shuffle">シャッフル</option>
        </select>
      </div>
    `;
    labelNode.parentElement.insertBefore(orderDiv, labelNode);
  }
});
</script>

</body>
</html>